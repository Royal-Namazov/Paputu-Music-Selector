<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music Segment Player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: white;
      text-align: center;
      padding-top: 50px;
    }
    button {
      background-color: #1DB954;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 25px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background-color: #1ed760;
    }
    #nowPlaying {
      margin-top: 30px;
      font-size: 22px;
    }
    #timer {
      margin-top: 10px;
      font-size: 18px;
      color: #B3B3B3;
    }
    #progressContainer {
      width: 300px;
      height: 10px;
      background-color: #333;
      border-radius: 5px;
      margin: 20px auto;
      overflow: hidden;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: #1DB954;
      transition: width 1s linear;
    }
  </style>
</head>
<body>

<h1>üéµ Music Segment Player üéµ</h1>
<button onclick="playNext()">‚ñ∂Ô∏è Play Next 1-Min Segment</button>

<p id="nowPlaying"></p>
<div id="timer">00:00 / 01:00</div>

<div id="progressContainer">
  <div id="progressBar"></div>
</div>

<audio id="player" preload="auto"></audio>

<script>
const musicFiles = [
  'music/music1.mp3', 'music/music2.mp3', 'music/music3.mp3', 'music/music4.mp3',
  'music/music5.mp3', 'music/music6.mp3', 'music/music7.mp3', 'music/music8.mp3',
  'music/music9.mp3', 'music/music10.mp3', 'music/music11.mp3', 'music/music12.mp3',
  'music/music13.mp3', 'music/music14.mp3', 'music/music15.mp3', 'music/music16.mp3',
  'music/music17.mp3', 'music/music18.mp3', 'music/music19.mp3', 'music/music20.mp3',
  'music/music21.mp3', 'music/music22.mp3', 'music/music23.mp3', 'music/music24.mp3',
  'music/music25.mp3', 'music/music26.mp3', 'music/music27.mp3', 'music/music28.mp3',
  'music/music29.mp3'
];

const player = document.getElementById('player');
const nowPlaying = document.getElementById('nowPlaying');
const timer = document.getElementById('timer');
const progressBar = document.getElementById('progressBar');

let currentTour = [];
let playedSegments = {};
let intervalId = null;

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

function prepareTour() {
  currentTour = shuffle(musicFiles.slice());
}

function getRandomNonOverlappingSegment(duration, previousSegments) {
  const safeStarts = [];

  for (let start = 0; start <= duration - 60; start += 1) {
    let ok = true;
    for (let usedStart of previousSegments) {
      if (Math.abs(start - usedStart) < 60) {
        ok = false;
        break;
      }
    }
    if (ok) safeStarts.push(start);
  }

  if (safeStarts.length === 0) {
    return Math.floor(Math.random() * (duration - 60)); // fallback random
  }

  const randomIndex = Math.floor(Math.random() * safeStarts.length);
  return safeStarts[randomIndex];
}

async function playNext() {
  if (intervalId) {
    clearInterval(intervalId);
    intervalId = null;
  }

  if (currentTour.length === 0) {
    prepareTour();
  }

  const file = currentTour.shift();
  player.src = file;
  await player.load();

  player.onloadedmetadata = () => {
    const duration = player.duration;
    const fileName = file.split('/').pop();

    if (!playedSegments[fileName]) playedSegments[fileName] = [];

    const startTime = getRandomNonOverlappingSegment(duration, playedSegments[fileName]);
    playedSegments[fileName].push(startTime);

    player.currentTime = startTime;
    player.play().then(() => {
      const musicNumber = parseInt(fileName.match(/\d+/)[0]);
      nowPlaying.textContent = `Playing music#${musicNumber}`;
      timer.textContent = `00:00 / 01:00`;

      progressBar.style.width = "0%";

      let elapsed = 0;
      intervalId = setInterval(() => {
        elapsed++;
        if (elapsed >= 60) {
          clearInterval(intervalId);
          player.pause();
          progressBar.style.width = "0%";
          playNext();
        } else {
          timer.textContent = `${String(Math.floor(elapsed/60)).padStart(2,'0')}:${String(elapsed%60).padStart(2,'0')} / 01:00`;
          progressBar.style.width = `${(elapsed / 60) * 100}%`;
        }
      }, 1000);
    }).catch(err => {
      console.error('Play error:', err);
      playNext();
    });
  };
}

window.onload = () => {
  prepareTour();
};
</script>

</body>
</html>
