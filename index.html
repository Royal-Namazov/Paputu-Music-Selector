<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Paputu Music Selector - Ultra Polished</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 60px;
    }

    button {
      padding: 12px 24px;
      font-size: 18px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background: #0056b3;
      transform: scale(1.05);
    }
    button:active {
      background: #004085;
      transform: scale(0.98);
    }

    #nowPlaying {
      margin-top: 20px;
      font-size: 20px;
    }

    #timer {
      margin-top: 10px;
      font-size: 18px;
    }

    #loader {
      display: none;
      margin-top: 20px;
      width: 40px;
      height: 40px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Fade-in/out effect */
    .fade {
      opacity: 0;
      transition: opacity 1s ease;
    }
    .fade.show {
      opacity: 1;
    }
  </style>
</head>
<body>

  <h1>ðŸŽµ Paputu Music Selector ðŸŽµ</h1>
  <button onclick="playNext()">Play 1-Min Random Segment</button>

  <p id="nowPlaying"></p>
  <div id="timer">00:00 / 01:00</div>

  <div id="loader"></div> <!-- Loader animation -->

  <!-- Double Audio: one for playing, one for preloading -->
  <audio id="player" preload="auto" crossorigin="anonymous"></audio>
  <audio id="preloader" preload="auto" crossorigin="anonymous" style="display:none;"></audio>

  <script defer>
    const musicFiles = [
      'music/music1.mp3', 'music/music2.mp3', 'music/music3.mp3', 'music/music4.mp3',
      'music/music5.mp3', 'music/music6.mp3', 'music/music7.mp3', 'music/music8.mp3',
      'music/music9.mp3', 'music/music10.mp3', 'music/music11.mp3', 'music/music12.mp3',
      'music/music13.mp3', 'music/music14.mp3', 'music/music15.mp3', 'music/music16.mp3',
      'music/music17.mp3', 'music/music18.mp3', 'music/music19.mp3', 'music/music20.mp3',
      'music/music21.mp3', 'music/music22.mp3', 'music/music23.mp3', 'music/music24.mp3',
      'music/music25.mp3', 'music/music26.mp3', 'music/music27.mp3', 'music/music28.mp3',
      'music/music29.mp3'
    ];

    let shuffledList = [];
    let currentIndex = 0;
    let intervalId = null;

    const player = document.getElementById('player');
    const preloader = document.getElementById('preloader');
    const nowPlaying = document.getElementById('nowPlaying');
    const timer = document.getElementById('timer');
    const loader = document.getElementById('loader');

    function shuffleArray(array) {
      const copy = array.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function formatTime(seconds) {
      const min = String(Math.floor(seconds / 60)).padStart(2, '0');
      const sec = String(Math.floor(seconds % 60)).padStart(2, '0');
      return `${min}:${sec}`;
    }

    function getSegmentStart(duration) {
      const segments = [];
      if (duration >= 60) segments.push(0);
      if (duration >= 120) {
        segments.push(Math.floor(duration / 2) - 30);
        segments.push(Math.floor(duration) - 60);
      }
      const index = Math.floor(Math.random() * segments.length);
      return segments[index];
    }

    function preloadNextTrack() {
      if (shuffledList.length === 0 || currentIndex >= shuffledList.length) {
        shuffledList = shuffleArray(musicFiles);
        currentIndex = 0;
      }
      const file = shuffledList[currentIndex];
      preloader.src = file;
      preloader.load();
    }

    function fadeIn(element) {
      element.classList.add('fade');
      setTimeout(() => element.classList.add('show'), 50);
    }

    function fadeOut(element) {
      element.classList.remove('show');
      setTimeout(() => element.classList.remove('fade'), 1000);
    }

    function playNext() {
      if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
      }

      if (shuffledList.length === 0 || currentIndex >= shuffledList.length) {
        shuffledList = shuffleArray(musicFiles);
        currentIndex = 0;
      }

      const file = shuffledList[currentIndex];
      const trackLabel = `music#${musicFiles.indexOf(file) + 1}`;
      currentIndex++;

      player.pause();
      fadeOut(loader);
      player.src = preloader.src || file;
      player.load();

      player.onloadedmetadata = () => {
        const duration = player.duration;

        if (duration < 60) {
          alert(`${trackLabel} is too short for 1-min segment. Skipping...`);
          playNext();
          return;
        }

        const startTime = getSegmentStart(duration);
        player.currentTime = startTime;

        fadeIn(loader); // Show loader before playing

        player.play().then(() => {
          nowPlaying.textContent = `Playing ${trackLabel} (Segment: 00:00 â€“ 01:00)`;
          timer.textContent = `00:00 / 01:00`;

          let currentTime = 0;
          intervalId = setInterval(() => {
            if (currentTime >= 60) {
              clearInterval(intervalId);
              intervalId = null;
              player.pause();
              nowPlaying.textContent = `Segment from ${trackLabel} ended.`;
              timer.textContent = `00:00 / 01:00`;

              fadeOut(loader); // Hide loader after play ends
            } else {
              currentTime++;
              timer.textContent = `${formatTime(currentTime)} / 01:00`;
            }
          }, 1000);

          preloadNextTrack();
        }).catch(error => {
          console.error('Error during play:', error);
          alert('Playback error. Try again!');
        });
      };
    }

    window.onload = preloadNextTrack;
  </script>

</body>
</html>
