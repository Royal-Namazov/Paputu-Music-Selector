<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Perfect Segment Player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: white;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    button {
      background-color: #1DB954;
      border: none;
      color: white;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 30px;
      cursor: pointer;
      margin: 20px 0;
      font-weight: bold;
    }
    #nowPlaying {
      font-size: 24px;
      margin: 20px 0;
      min-height: 60px;
    }
    #timer {
      font-family: monospace;
      font-size: 20px;
    }
    #tourInfo {
      font-size: 18px;
      color: #1DB954;
      margin: 10px 0;
    }
    .volume-control {
      margin: 20px auto;
      width: 200px;
    }
    .segment-info {
      margin-top: 20px;
      font-size: 16px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>Perfect Segment Player</h1>
  <div id="tourInfo">Tour 1: 29 tracks remaining</div>
  <button id="playButton">NEXT SEGMENT</button>
  <div id="nowPlaying">Initializing player...</div>
  <div id="timer">00:00 / 01:00</div>
  <div class="segment-info" id="segmentInfo">Segment: -</div>
  
  <div class="volume-control">
    <input type="range" id="volume" min="0" max="1" step="0.01" value="0.7">
  </div>

  <!-- Audio elements pool -->
  <audio id="player1"></audio>
  <audio id="player2"></audio>
  
  <script>
    // Configuration
    const SEGMENT_LENGTH = 60; // 1 minute segments
    const TRACK_COUNT = 29; // Number of music tracks
    
    // DOM elements
    const playButton = document.getElementById('playButton');
    const nowPlaying = document.getElementById('nowPlaying');
    const timer = document.getElementById('timer');
    const volumeControl = document.getElementById('volume');
    const tourInfo = document.getElementById('tourInfo');
    const segmentInfo = document.getElementById('segmentInfo');
    
    // Audio elements
    const players = [
      document.getElementById('player1'),
      document.getElementById('player2')
    ];
    
    // State
    const state = {
      currentPlayer: 0,
      nextPlayer: 1,
      currentTrack: null,
      currentSegment: 0,
      elapsed: 0,
      timerInterval: null,
      currentTour: 1,
      remainingTracks: [],
      usedSegments: {},
      segmentHistory: Array.from({length: TRACK_COUNT}, () => []),
      segmentTypes: ['first', 'last', 'middle-first', 'middle-last']
    };
    
    // Initialize
    function init() {
      // Set initial volume
      players.forEach(p => p.volume = volumeControl.value);
      volumeControl.addEventListener('input', () => {
        players.forEach(p => p.volume = volumeControl.value);
      });
      
      // Initialize track order and segments
      startNewTour();
      
      // Button handler
      playButton.addEventListener('click', playNextSegment);
      
      // Start with first track
      loadNextTrack();
    }
    
    function startNewTour() {
      state.currentTour++;
      state.remainingTracks = shuffleArray([...Array(TRACK_COUNT).keys()].map(i => i + 1));
      tourInfo.textContent = `Tour ${state.currentTour}: ${state.remainingTracks.length} tracks remaining`;
    }
    
    function loadNextTrack() {
      if (state.remainingTracks.length === 0) {
        startNewTour();
      }
      
      state.currentTrack = state.remainingTracks.pop();
      state.currentSegment = 0;
      
      const player = players[state.nextPlayer];
      player.src = `music/music${state.currentTrack}.mp3`;
      player.load();
      
      player.addEventListener('canplaythrough', () => {
        playCurrentSegment();
      }, { once: true });
    }
    
    function playCurrentSegment() {
      const player = players[state.currentPlayer];
      const duration = player.duration;
      
      // Get segment position based on tour rules
      const segmentData = getSegmentData(state.currentTrack, duration);
      state.currentSegment++;
      
      player.currentTime = segmentData.startTime;
      player.play()
        .then(() => {
          updateUI(segmentData.type);
          startTimer();
          
          // Preload next track if available
          if (state.remainingTracks.length > 0) {
            loadNextTrack();
          }
        })
        .catch(err => {
          console.error("Play error:", err);
          playNextSegment();
        });
    }
    
    function getSegmentData(trackNumber, duration) {
      const trackIndex = trackNumber - 1;
      const segmentsAvailable = Math.floor(duration / SEGMENT_LENGTH);
      
      // First tour - random segment types
      if (state.currentTour === 1) {
        const type = state.segmentTypes[Math.floor(Math.random() * state.segmentTypes.length)];
        
        let startTime;
        switch(type) {
          case 'first':
            startTime = 0;
            break;
          case 'last':
            startTime = Math.max(0, duration - SEGMENT_LENGTH);
            break;
          case 'middle-first':
            startTime = Math.max(0, duration/2 - SEGMENT_LENGTH);
            break;
          case 'middle-last':
            startTime = Math.min(duration/2, duration - SEGMENT_LENGTH);
            break;
        }
        
        state.segmentHistory[trackIndex].push(type);
        return { type, startTime };
      }
      
      // Subsequent tours - use different segments than previous tours
      const availableTypes = state.segmentTypes.filter(type => 
        !state.segmentHistory[trackIndex].includes(type)
      );
      
      if (availableTypes.length > 0) {
        const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
        
        let startTime;
        switch(type) {
          case 'first':
            startTime = 0;
            break;
          case 'last':
            startTime = Math.max(0, duration - SEGMENT_LENGTH);
            break;
          case 'middle-first':
            startTime = Math.max(0, duration/2 - SEGMENT_LENGTH);
            break;
          case 'middle-last':
            startTime = Math.min(duration/2, duration - SEGMENT_LENGTH);
            break;
        }
        
        state.segmentHistory[trackIndex].push(type);
        return { type, startTime };
      }
      
      // If all special segments used, pick random unused segment
      if (!state.usedSegments[trackIndex]) {
        state.usedSegments[trackIndex] = new Set();
      }
      
      let randomSegment;
      do {
        randomSegment = Math.floor(Math.random() * segmentsAvailable);
      } while (state.usedSegments[trackIndex].has(randomSegment) && 
               state.usedSegments[trackIndex].size < segmentsAvailable);
      
      state.usedSegments[trackIndex].add(randomSegment);
      return {
        type: 'random',
        startTime: randomSegment * SEGMENT_LENGTH
      };
    }
    
    function playNextSegment() {
      clearInterval(state.timerInterval);
      
      // Switch players for next segment/track
      [state.currentPlayer, state.nextPlayer] = [state.nextPlayer, state.currentPlayer];
      playCurrentSegment();
    }
    
    function startTimer() {
      state.elapsed = 0;
      clearInterval(state.timerInterval);
      updateTimerDisplay();
      
      state.timerInterval = setInterval(() => {
        state.elapsed++;
        updateTimerDisplay();
        
        if (state.elapsed >= SEGMENT_LENGTH) {
          playNextSegment();
        }
      }, 1000);
    }
    
    function updateTimerDisplay() {
      timer.textContent = `${String(Math.floor(state.elapsed / 60)).padStart(2, '0')}:${String(state.elapsed % 60).padStart(2, '0')} / 01:00`;
    }
    
    function updateUI(segmentType) {
      nowPlaying.textContent = `Playing TRACK ${state.currentTrack}`;
      segmentInfo.textContent = `Segment: ${segmentType}`;
      tourInfo.textContent = `Tour ${state.currentTour}: ${state.remainingTracks.length} tracks remaining`;
    }
    
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    
    // Start the player
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
